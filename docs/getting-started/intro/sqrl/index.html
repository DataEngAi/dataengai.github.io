<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DataSQRL RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DataSQRL Atom Feed"><title data-react-helmet="true">Write SQRL Script | DataSQRL</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://dataengai.github.io/docs/getting-started/intro/sqrl"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Write SQRL Script | DataSQRL"><meta data-react-helmet="true" name="description" content="The logic and function of a data service is defined in the SQRL script."><meta data-react-helmet="true" property="og:description" content="The logic and function of a data service is defined in the SQRL script."><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://dataengai.github.io/docs/getting-started/intro/sqrl"><link data-react-helmet="true" rel="alternate" href="https://dataengai.github.io/docs/getting-started/intro/sqrl" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://dataengai.github.io/docs/getting-started/intro/sqrl" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.deb948f4.css">
<link rel="preload" href="/assets/js/runtime~main.11892a8a.js" as="script">
<link rel="preload" href="/assets/js/main.e9ba1207.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/head_squirrel.svg" alt="DataSQRL Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/head_squirrel.svg" alt="DataSQRL Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">DataSQRL</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/getting-started/overview">Learn</a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/blog">News</a><a class="navbar__item navbar__link" href="/support">Support</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tbd" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleChecked_cnQY toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" checked="" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/docs/getting-started/overview">Getting Started</a><button aria-label="Toggle the collapsible sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/install">Download &amp; Install</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/nutshop-tutorial">Intro Tutorial</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/docs/getting-started/intro/overview">DataSQRL Training</a><button aria-label="Toggle the collapsible sidebar category &#x27;DataSQRL Training&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/intro/data-sources">Connect Data Source</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/getting-started/intro/sqrl">Write SQRL Script</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/intro/api">Using the API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/intro/server">Operating DataSQRL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/intro/advanced">Advanced Concepts</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started/why-datasqrl">Why DataSQRL?</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" tabindex="0" href="/docs/getting-started/comparison/overview">DataSQRL Comparison</a><button aria-label="Toggle the collapsible sidebar category &#x27;DataSQRL Comparison&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/guides/overview">How-to Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;How-to Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/reference/overview">Reference Documentation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference Documentation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/dev/overview">Developer Documentation</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Documentation&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Writing SQRL Scripts</h1><p>The logic and function of a data service is defined in the SQRL script.
That&#x27;s where the action is. We are going to dive deeper into
the SQRL language and how to write SQRL scripts by reviewing and extending the
<a href="/docs/getting-started/nutshop-tutorial">nut shop tutorial</a>.</p><p>When you make it through this document, you will know the key concepts
of SQRL, be ready to write your own SQRL scripts, and take the world by storm
with your new data service.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="whats-in-a-sqrl-script">What&#x27;s in a SQRL Script?<a class="hash-link" href="#whats-in-a-sqrl-script" title="Direct link to heading">â€‹</a></h2><p>An SQRL script defines tables and relationships between them. Together, they
form the data model of the data service which is exposed as an API.</p><p>That&#x27;s pretty much all there is to it. You define tables holding rows of data
and relationships between those row records and the resulting data model
can be navigated through an API that DataSQRL generates for you.</p><p>Tables and relationships are defined in SQL - with some additions and a little
bit of syntactic sugar thrown in there to make your life easier. We call
the resulting language variant <strong>SQRL</strong>.</p><p>The rest of this document explains how to define tables and relationships
in SQRL so you can build the data service of your dreams.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>If you are unfamiliar with SQL, we recommend you read the
<a href="/docs/reference/sqrl/sql-primer">SQL Primer</a> which introduces
the basic concepts of SQL.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="tables">Tables<a class="hash-link" href="#tables" title="Direct link to heading">â€‹</a></h2><p>A table is made up of columns (or fields) and rows. A row represents a data record.
Columns have a data type and represent an attribute of a record in the table. We often
refer to columns as <em>fields</em> in the context of a data record. Records and rows, columns
and fields, Darth Vader and Anakin Skywalker are all name pairs that describe the same
thing.</p><p>Tables are the central concept of SQRL. Tables structure and contain all the data you
are building with in an SQRL script. Tables are exposed as endpoints in the API that
DataSQRL generates for you, so you can query the data in them.</p><p>You define most tables in SQRL using one of 3 ways: by import, by query, or incrementally.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="import">Import<a class="hash-link" href="#import" title="Direct link to heading">â€‹</a></h3><p>An important statement adds the table you are importing to your SQRL script.
In the <a href="/docs/getting-started/nutshop-tutorial#adding-data">nut shop tutorial</a> we imported the
<code>Products</code> and <code>Orders</code> tables.</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">IMPORT nutshop-data.Products;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">IMPORT nutshop-data.Orders;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>These tables are now defined in our script and we can transform, query, or otherwise build with
the data they contain. The <a href="/docs/getting-started/intro/data-sources#basics">previous section</a> explains how to connect
data sources to DataSQRL for importing data.</p><p>Import statements are at the top of your SQRL script so you can see all the data you are importing
at one glance.</p><p>Let&#x27;s import the nutritional information from our cloud bucket data source by adding the
following import statement to the top of our customer 360 script: </p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">IMPORT usda-data.Nuts;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This defines a <code>Nuts</code> table based on the data in the <code>nuts.json</code> file that&#x27;s contained in the
connected cloud bucket. Each JSON object in that file is represented by a row in the <code>Nuts</code> table.
We&#x27;ll use the data in the <code>Nuts</code> table for our recommendation engine later on.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="query">Query<a class="hash-link" href="#query" title="Direct link to heading">â€‹</a></h3><p>Once you have imported tables, you build with the data they contain.
You do this by defining new tables that query the data in existing ones.</p><p>In the <a href="/docs/getting-started/nutshop-tutorial#structure">intro tutorial</a> we defined the <code>Customers</code> table by querying
for all the unique customer ids in the <code>Orders</code> table:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers := SELECT DISTINCT customerid AS id FROM Orders;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>You can bring to bear all the SQL you already know to define new tables in SQRL.
For example, suppose PM is telling us that they want to add a McDonald&#x27;s inspired
<em>&quot;over X million orders served&quot;</em> banner to the nut shop homepage. \
We define a new <code>NumOrders</code> table that contains the count:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">NumOrders := SELECT COUNT(*) AS count FROM Orders;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The <code>NumOrders</code> table gets exposed in our data service API as an additional endpoint
through which the frontend team can query for the current order count.</p><div class="codeBlockContainer_I0IT language-graphql theme-code-block"><div class="codeBlockContent_wNvx graphql"><pre tabindex="0" class="prism-code language-graphql codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    numorders</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        count</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>DataSQRL is still young and we are actively working on SQL feature parity in SQRL.
Take a look at the <a href="/docs/dev/roadmap#sql-parity">roadmap</a> for current
limitations and what we are working on.</p></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="incrementally">Incrementally<a class="hash-link" href="#incrementally" title="Direct link to heading">â€‹</a></h3><p>You can also define tables incrementally by adding new columns to an
existing table.</p><p>In the nut shop tutorial, we added the column <code>date</code> to the <code>Orders</code> table:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Orders.date := function.time.fromEpochMillis(time);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The part on the left-hand side of the
assignment operator <code>:=</code> is the fully specified <code>Orders.date</code> column
we are defining. The part on the right-hand side is the actual definition.
In this case, we are applying the function <code>fromEpochMillis</code> within the
<code>time</code> function package to the <code>time</code> column to convert it to a <code>DateTime</code>.</p><p>This is a <strong>localized expression</strong> that is evaluated within the context
of the table on the left-hand side - in this case <code>Orders</code>. That&#x27;s why
we can refer to the <code>time</code> column of the <code>Orders</code> table without any
qualifiers.</p><p>For more complex column definitions,
we can use the full <code>SELECT</code> query syntax.</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers.since := SELECT MIN(o.date) FROM Orders o WHERE o.customerid = _.id;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This statement defines a new column <code>since</code> on the <code>Customers</code> table as the
date when the customer placed their first order.</p><p>The <code>SELECT</code> query on the right is a <strong>localized query</strong> that is evaluated within
the context of the <code>Customers</code> table. Think of a localized query
as being executed for each row of table on the left-hand side. We can use the special table
handle <code>_</code> to refer to column values of that row. \
In this instance, <code>_.id</code> refers to the <code>id</code> columns of the <code>Customers</code> table.</p><p>Localized queries are a feature of SQRL that allows incremental table definitions
and simplifies queries because we don&#x27;t have to write the implicit JOIN between
<code>Customers</code> and <code>Orders</code> in the statement above.</p><p>Localized queries in incremental column definitions must return a single value
which gets assigned to the defined column. In other words, the query must be
guaranteed to return a single row with a single column in it.</p><hr><h3 class="anchor anchorWithStickyNavbar_mojV" id="table-schema">Table Schema<a class="hash-link" href="#table-schema" title="Direct link to heading">â€‹</a></h3><p>The data type of columns is inferred from the input data or definition of the table.
In our example, the <code>time</code> column on the <code>Orders</code> table is of type <code>Number</code> which
DataSQRL inferred from the records in the orders data. The data type of the <code>date</code> column
defined above is <code>DateTime</code> which is inferred from the result type of the <code>fromEpochMillis</code>
function.</p><p>In most cases, type inference is obvious and you can let DataSQRL handle data types and schema for you.
One less thing to worry about. \
Read more about <a href="/docs/reference/sources/schema-management">schema management</a>
and how to <a href="/docs/guides/sources/manual-schema">manually define data types</a> for
datasets with heterogeneous or very messy data where it isn&#x27;t obvious.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="relationships">Relationships<a class="hash-link" href="#relationships" title="Direct link to heading">â€‹</a></h2><p>Relationships relate records within and between tables.
Defining relationships has two benefits:</p><ol><li>Relationships are exposed in the API allowing consumers
to retrieve related records within a single request.</li><li>Relationships can be used in queries instead of explicit
JOINs which simplifies queries and makes them more readable.
This is particularly useful when we query along the same
relationship multiple times.</li></ol><p>In the nut shop tutorial, we defined the following relationship between
the <code>Customers</code> and <code>Orders</code> table:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers.purchases := JOIN Orders ON Orders.customerid = _.id ORDER BY Orders.time DESC;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>A relationship is defined by a JOIN between two or more tables using the standard
SQL <code>JOIN ... ON ...</code> syntax. The starting point of the JOIN is always the table
on the left-hand side and we can use the special table handle <code>_</code> to refer to
it in the JOIN expression. In this case, <code>Customers</code> is our <em>start</em> table and
<code>Orders</code> is our <em>end</em> table of the relationship definition.</p><p>In addition to the <code>JOIN [table] ON [condition]</code> expression, a relationship
definition can end with an optional <code>ORDER BY</code> and <code>LIMIT</code> clause. The order
is used as the default ordering when the relationship is accessed through the API.
The limit specifies the maximum number of related rows that are returned
when traversing the relationship (i.e. the maximum multiplicity).</p><p>The relationship is defined as a field
on the start table, which is how we access it in the script or through the API:</p><div class="codeBlockContainer_I0IT language-graphql theme-code-block"><div class="codeBlockContent_wNvx graphql"><pre tabindex="0" class="prism-code language-graphql codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    customers</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token attr-name" style="color:rgb(241, 250, 140)">filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token attr-name" style="color:rgb(241, 250, 140)">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token attr-name" style="color:rgb(241, 250, 140)">eq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;50&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        data</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            purchases</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token attr-name" style="color:rgb(241, 250, 140)">limit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token number">10</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                id</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                time</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We can also access relationships when we define tables or columns in our
SQRL script:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customer.total_orders := SUM(purchases.total);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In this incremental column definition from the nut shop tutorial, we are summing
the total value of all orders related to a particular customer record by the
<code>purchases</code> relationship.</p><p>This expression is much easier to read and write than the equivalent
definition:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers.total_orders := SELECT SUM(o.total) FROM Orders o WHERE o.customerid = _.id;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And we can reuse relationships across definitions. For instance, we can rewrite
the definition of the <code>since</code> column on <code>Customers</code> as:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers.since := MIN(purchases.date);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Relationships make it easier to implement SQRL scripts, allow you to reuse JOINs
between queries, and add structure to your data model which is accessible through
the API. Adding structure to your data by explicitly defining relationships also
clarifies the data itself and how you plan to use it.</p><p>For example, by defining relationships between the <code>Nuts</code> and <code>Products</code> tables
we explicitly establish a 1-to-1 relationship between those two sets of records
that we can use to enrich our <code>Products</code> data with additional information.</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Products.nutrition := JOIN Nuts ON Nuts.fdcID = _.usda_id LIMIT 1;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Nuts.product := JOIN Products ON _.fdcID = Products.usda_id LIMIT 1;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="nested-tables">Nested Tables<a class="hash-link" href="#nested-tables" title="Direct link to heading">â€‹</a></h2><p>SQRL supports nested and hierarchical data like JSON objects through nested tables.
A nested table has a parent table and all rows in a nested table are associated
with a single parent row in the parent table.</p><p>In the nut shop tutorial the <code>Orders</code> table has a nested <code>Orders.entries</code> table
that contains the entry records for each order. When referring to a nested table,
we have to use the fully qualified name of the table which includes the parent.
<code>SELECT * FROM Orders.entries</code> is valid but <code>SELECT * FROM entries</code> is not because
there is no table with that name in the global namespace of the SQRL script.</p><p>SQRL automatically adds a relationship field with the name of the nested
table to the parent table which relates all child records to the parent
record. The <code>entries</code> relationship on the <code>Orders</code> table can be used to query
the entry records for a particular order, e.g.
<code>SELECT SUM(entries.discount) AS order_discount FROM Orders</code>. \
Likewise, SQRL adds a <code>parent</code> relationship on the child table which relates
rows to their parent rows in the parent table. This relationship can be used
to refer to parent row attributes, e.g.
<code>SELECT productid, parent.date FROM Orders.entries</code></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="defining-nested-tables">Defining Nested Tables<a class="hash-link" href="#defining-nested-tables" title="Direct link to heading">â€‹</a></h3><p>We can also define nested tables in SQRL. In the nut shop tutorial, we defined
the nested table <code>Customers.spending_by_month</code> to aggregate spending by month
for each customer. Nested tables are useful when we want to analyze our data
in partitions, like order totals and discounts by customer.</p><p>Whenever you want to build data analysis <strong>by dimension</strong> or compute a
result set <strong>for each record</strong>, nested tables are your friend.</p><p>For example, let&#x27;s build the simplest and most effective product recommendation
into our customer 360: recommending products customers have already purchased
orderd by frequency. In other words, we want to look at all the products purchased
<strong>for each customer</strong> and sort them by frequency of purchase:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers.past_purchases :=</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         SELECT e.productid, count(e.*) as num_orders, sum(e.quantity) as total_quantity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         FROM _.purchases.entries e</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         ORDER BY count DESC, quantity DESC;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The table <code>past_purchases</code> is defined as a nested table within <code>Customers</code>.
The SQL query on the right-hand side is a
<em>localized query</em> which means it is evaluated in the context of the <code>Customers</code>
table. Nested tables are always defined in the context of the parent table
and we can think of the query definition as being applied to <em>each row</em> of the
parent table.</p><p>We use the special table handle <code>_</code> to refer to each row in the parent
<code>Customers</code> table. The <code>FROM</code> clause <code>_.purchases.entries</code> chains together
the <code>purchases</code> relationship on <code>Customers</code> with the <code>entries</code> relationship
on <code>Orders</code> to retrieve all entry records for all order records associated
with a single customer record. Chaining together relationships allows us to
avoid the complexity of multiple JOIN expressions in this query.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="event-entity">Event vs Entity Tables<a class="hash-link" href="#event-entity" title="Direct link to heading">â€‹</a></h2><p>We distinguish between event and entity tables in SQRL.</p><p>An <strong>event table</strong> consists of immutable (i.e. unchanging) rows of data that
are incrementally added to the table over time and never deleted.
The <code>Orders</code> table in the
nut shop tutorial is an event table because an order does not change once
it has been processed.</p><p>In an <strong>entity table</strong> the column values of rows change over time and rows
are added to and deleted from the table. The <code>Products</code> table is an entity
table because it represents our current list of products which may change
over time.</p><p>Why is this distinction important? Because DataSQRL treats all data
produced by data sources as event tables. When you import a table, you
get an event table of immutable records that are ingested from the
data source in realtime.</p><p>Let&#x27;s do a little experiment to see how this works. While you still have
the nut shop data service running, open up an editor to modify the
<code>products.csv</code> file by removing the word <em>&quot;(desiccated)&quot;</em> from the product
name of the first record on line 2. Then save the file. Because the
data was modified, this triggers an update from the data source and
DataSQRL ingests all the product records again.</p><p>When we <a href="/docs/getting-started/nutshop-tutorial#api">query the API</a>
for products with <code>id=1</code> we get
two results with slightly different names.</p><div class="codeBlockContainer_I0IT language-graphql theme-code-block"><div class="codeBlockContent_wNvx graphql"><pre tabindex="0" class="prism-code language-graphql codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    products</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token attr-name" style="color:rgb(241, 250, 140)">filter</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"> </span><span class="token attr-name" style="color:rgb(241, 250, 140)">id</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token attr-name" style="color:rgb(241, 250, 140)">eq</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        data </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            sizing</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            weight_in_grams</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In fact, we now have duplicate records for all products: one from
before we edited the file and one from after. That&#x27;s because
DataSQRL treats all source data as an event stream. If the underlying
data are entities, like products in our case, then we get an event
stream of updates to those entities.</p><p>To get a <code>Products</code> entity table with a single, most-recent version
of each product, we have to
define <code>Products</code> as a deduplicated entity table at the top of our
SQRL script after the imports:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Products := DISTINCT Products ON id ORDER BY _ingest_time DESC;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This defines an entity table that takes the most recent update
for each product by id. In this case <em>recency</em> is defined by
the <code>_ingest_time</code> column which is a column that exists on all
event tables and marks the time when a record was ingested by
DataSQRL.</p><p>When you run the products API query again you only get a single
result with the most current product.</p><p>When we are dealing with static data, there is no real difference
between event and entity tables. However, when dealing with
streaming data and connecting to data in databases it is important
to understand the difference.</p><p>A useful way to think about it: events happen and don&#x27;t change
after the fact whereas entities evolve over time. When you import
a table that you want to treat as an entity, make sure to use a
<code>DISTINCT</code> query to define the table as an entity table.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="time">Time<a class="hash-link" href="#time" title="Direct link to heading">â€‹</a></h2><p>When building real-time data services, <em>time</em> is often an important aspect.
The two most common time-based transformations on data are grouping data
points by time buckets and slicing data by recent time interval. SQRL provides
convenience features to address both of those.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="time-buckets-for-grouping">Time Buckets for Grouping<a class="hash-link" href="#time-buckets-for-grouping" title="Direct link to heading">â€‹</a></h3><p>For our nut shop customer 360 we computed customer spending and savings
profiles by month as follows:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers.spending_by_month :=</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         SELECT function.time.truncateToMonth(date) AS month,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                sum(total) AS total_spend,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                sum(discount) AS total_savings</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         FROM _.purchases</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         GROUP BY month ORDER BY month DESC;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This defines a nested table which aggregates over the orders for each customer.
SQRL has a built-in library of <a href="/docs/reference/sqrl/functions/time-fct"><em>time</em> functions</a>
that compute time buckets of
various durations. We can then group on those buckets in order to compute
aggregates across non-overlapping time intervals. In this example, we
bucket order records into month-long intervals based on the order date to
sum up the total and discounts for each month.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="time-slices-for-recency">Time Slices for Recency<a class="hash-link" href="#time-slices-for-recency" title="Direct link to heading">â€‹</a></h3><p>Another common time analysis is by recent time slice, i.e. you want to analyze
all records that are younger than some amount of time.</p><p>For our nut shop, we want to add
another recommendation service that recommends products our customers are likely
to buy but might not have bought yet. \
Our nut shop customers closely watch their protein intake.
After all, if you are climbing trees all day you
need to feed your muscles. That&#x27;s why we want to recommend products that
have a similar protein content to the average amount of protein a customer
has recently consumed.</p><p>First, let&#x27;s compute the average recent protein intake based on a customer&#x27;s
past purchases.</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers.recent_avg_protein :=</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      SELECT SUM(e.quantity * p.weight_in_gram * n.protein)/SUM(e.quantity * p.weight_in_gram)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      FROM _.purchases.entries e JOIN e.product p JOIN p.nutrition n</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      WHERE e.parent.date &gt; now() - INTERVAL 6 MONTH;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>In the <code>FROM</code> clause of this query, we are joining the order entries a customer has
bought with the product information and the nutritional information so we can compute
the average protein content. Note, how we are using the previously defined relationships
instead of table names in the JOIN expressions to chain the relationships together.
In the <code>WHERE</code> clause we are filtering out any order that is older than 6 months by using
the special <code>now()</code> function which is used to define recent time slices.</p><p><code>now()</code> stands for the current system time which means the result of this query will
change as time progresses.</p><p>We will use the value <code>recent_avg_protein</code> defined above to define another
nested table that ranks all the nut products we offer in the store by similarity
of protein content.</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers.products_by_protein :=</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SELECT p.id AS productid, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       ABS(p.nutrition.protein-_.recent_avg_protein) AS protein_difference </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM Products p ORDER BY protein_difference ASC LIMIT 20;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Finally, we add a relationship to this nested table to relate those records back
to our <code>Products</code> table:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">Customers.products_by_protein.product := JOIN Products ON Products.id = _productid LIMIT 1;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>And that, my friend, is a pretty good start for a novel product recommendation engine.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="subscriptions">Subscriptions<a class="hash-link" href="#subscriptions" title="Direct link to heading">â€‹</a></h2><p>The last feature we want to implement in our customer 360 is a trigger or
notification when a customer has more than $100 in purchases so that we can
email them with a special coupon to reward their loyalty.</p><p>SQRL supports subscriptions which observe an underlying table and trigger
events.</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">NewCustomerPromotion := SUBSCRIPTION ON ADD AS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      SELECT customerid, total_orders </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      FROM Customers WHERE total_orders &gt;= 100;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>We define the subscription <code>NewCustomerPromotion</code> which observes the table
defined by the <code>SELECT</code> query for all customers with more than $100 in total
purchases. The <code>ON ADD</code> qualifier for this subscription means that an event
is triggered whenever a new row is added to that table.</p><p>A subscription defines an event table that contains a row for every
event that is triggered by the underlying table. We can treat it like any other
table, for example, by defining a relationship to <code>Customers</code>:</p><div class="codeBlockContainer_I0IT language-sqrl theme-code-block"><div class="codeBlockContent_wNvx sqrl"><pre tabindex="0" class="prism-code language-sqrl codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">NewCustomerPromotion.customer := JOIN Customers ON Customers.id = _.customerid;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>However, subscriptions are special in that they are exposed as WebSockets in the
API that proactively sent out events when they occur to subscribing users. In
addition, we can register queues with DataSQRL server where subscription events
get posted to notify downstream systems. We are going to look into
both of those subscription access methods in more detail in the <a href="/docs/getting-started/intro/api">next section</a>.</p><p>Subscriptions are a powerful feature to <em>react</em> to changes in the data and
notify downstream systems or consumers of the API immediately.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="next-steps">Next Steps<a class="hash-link" href="#next-steps" title="Direct link to heading">â€‹</a></h2><p>We&#x27;ve built a complete customer 360 with two complementary recommendation engines and
promotions. Good work ðŸ’ª! Take a look at the <a href="/">final Customer 360 SQRL script</a>.</p><p>You&#x27;ve learned enough about SQRL to start building data services on your own. Next,
we are going to take a closer look at the API that DataSQRL generates from your
scripts and how to access it.</p><hr><p>We&#x27;ve covered the 80% of SQRL you need in this document. If you want to know more:</p><ul><li>Take a look at the <a href="/docs/guides/sqrl/overview">SQRL guides</a> for
advice on solving specific problems in SQRL</li><li>Learn more about the key SQRL concepts of <a href="/docs/reference/sqrl/table">tables</a>,
<a href="/docs/reference/sqrl/relationship">relationships</a>, and <a href="/docs/reference/sqrl/time">time</a>.</li><li>If you want to know it <em>all</em>, take a look at the <a href="/docs/reference/sqrl/grammar">SQRL language reference</a>.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/dataengai/dataengai.github.io/edit/main/docs/docs/getting-started/intro/sqrl.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/getting-started/intro/data-sources"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Connect Data Source</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/getting-started/intro/api"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Using the API</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#whats-in-a-sqrl-script" class="table-of-contents__link toc-highlight">What&#39;s in a SQRL Script?</a></li><li><a href="#tables" class="table-of-contents__link toc-highlight">Tables</a><ul><li><a href="#import" class="table-of-contents__link toc-highlight">Import</a></li><li><a href="#query" class="table-of-contents__link toc-highlight">Query</a></li><li><a href="#incrementally" class="table-of-contents__link toc-highlight">Incrementally</a></li><li><a href="#table-schema" class="table-of-contents__link toc-highlight">Table Schema</a></li></ul></li><li><a href="#relationships" class="table-of-contents__link toc-highlight">Relationships</a></li><li><a href="#nested-tables" class="table-of-contents__link toc-highlight">Nested Tables</a><ul><li><a href="#defining-nested-tables" class="table-of-contents__link toc-highlight">Defining Nested Tables</a></li></ul></li><li><a href="#event-entity" class="table-of-contents__link toc-highlight">Event vs Entity Tables</a></li><li><a href="#time" class="table-of-contents__link toc-highlight">Time</a><ul><li><a href="#time-buckets-for-grouping" class="table-of-contents__link toc-highlight">Time Buckets for Grouping</a></li><li><a href="#time-slices-for-recency" class="table-of-contents__link toc-highlight">Time Slices for Recency</a></li></ul></li><li><a href="#subscriptions" class="table-of-contents__link toc-highlight">Subscriptions</a></li><li><a href="#next-steps" class="table-of-contents__link toc-highlight">Next Steps</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started/overview">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Documentation Overview</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/reference/overview">Reference Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/dev/overview">Developer Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://slack.com/invite/datasqrl" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/datasqrl" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">News</a></li><li class="footer__item"><a class="footer__link-item" href="/support">Support</a></li><li class="footer__item"><a href="https://github.com/tbd" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 DataSQRL, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.11892a8a.js"></script>
<script src="/assets/js/main.e9ba1207.js"></script>
</body>
</html>